#!/bin/sh
# Simple pre-commit hook to scan staged files for common secret patterns.
# To enable for this repo (once): git config core.hooksPath .githooks

PATTERNS='(AIza|-----BEGIN PRIVATE KEY-----|SERVICE_ROLE|SUPABASE_SERVICE_ROLE_KEY|supabase\.co|api_key|apikey|ACCESS_TOKEN)'
FAIL=0

echo "[pre-commit] scanning staged files for secrets..."

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
if [ -z "$STAGED_FILES" ]; then
  echo "[pre-commit] no staged files to check."
  exit 0
fi

for file in $STAGED_FILES; do
  # skip binary files heuristically
  if git show :"$file" | head -c 8000 | grep -q "\x00"; then
    continue
  fi

  if git show :"$file" | grep -En "$PATTERNS" >/dev/null 2>&1; then
    echo "Potential secret found in: $file"
    git show :"$file" | grep -En "$PATTERNS" --color=always || true
    FAIL=1
  fi
done

if [ "$FAIL" -ne 0 ]; then
  echo "\n[pre-commit] Commit aborted: possible secrets detected. Remove them or use --no-verify to bypass."
  exit 1
fi

echo "[pre-commit] no obvious secrets found."
exit 0
