<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>OAuth callback</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
  </head>
  <body>
    <p id="status">Finalizando autenticação...</p>
    <script>
      (function(){
        try {
          const hash = window.location.hash && window.location.hash.startsWith('#') ? window.location.hash.slice(1) : window.location.hash || '';
          const params = Object.fromEntries(new URLSearchParams(hash));

          // Send only to opener if it exists
          if (window.opener && !window.opener.closed) {
            try {
              window.opener.postMessage({ type: 'supabase_oauth', payload: params }, window.location.origin);
            } catch (e) {
              // Fallback to wildcard if origin posting fails
              try { window.opener.postMessage({ type: 'supabase_oauth', payload: params }, '*'); } catch (e2) {}
            }
          }

          // Wait for an ACK from the opener before closing to ensure message delivered and processed
          let closed = false;
          function closeWindow() {
            if (closed) return; closed = true;
            try { window.close(); } catch (e) { /* ignore */ }
          }

          function onMessage(ev) {
            try {
              if (!ev || !ev.data) return;
              if (ev.data && ev.data.type === 'supabase_oauth_ack') {
                // opener confirmed processing; close now
                closeWindow();
              }
            } catch (e) {}
          }

          window.addEventListener('message', onMessage, false);

          // Fallback: close after 6s if no ACK received
          setTimeout(() => {
            window.removeEventListener('message', onMessage, false);
            closeWindow();
          }, 6000);

        } catch (e) {
          console.error('oauth-callback error', e);
          try { setTimeout(() => window.close(), 1500); } catch(e) {}
        }
      })();
    </script>
  </body>
</html>
