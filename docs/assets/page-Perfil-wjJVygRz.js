import{r as h,A as y,j as e,T as C}from"./index-VModOzao.js";import{M as b}from"./index.esm-CbLAFu9b.js";import{a as f}from"./apiService-DRkEcca-.js";import"./glossarioData-8VebtgBN.js";function R({formData:x={},onChange:A=()=>{},onSave:P=()=>{},onCancel:E=()=>{},showPassword:D=!1,onToggleShowPassword:k=()=>{}}){const{usuarioLogado:o,setUsuarioLogado:U}=h.useContext(y)||{},[s,p]=h.useState({nome:"",celular:"",email:"",senhaAtual:"",novaSenha:"",confirmNovaSenha:""}),[g,_]=h.useState(!1),[S,$]=h.useState(!1),[w,O]=h.useState(!1),[n,m]=h.useState({});h.useEffect(()=>{o&&p({nome:o.nome||"",celular:o.celular||"",email:o.email||"",senhaAtual:"",novaSenha:"",confirmNovaSenha:""})},[o]);function L(){const a={};return s.nome.trim()||(a.nome="Nome é obrigatório"),s.email.trim()?/^\S+@\S+\.\S+$/.test(s.email)||(a.email="E-mail inválido"):a.email="E-mail é obrigatório",s.celular.trim()?/^\d{8,}$/.test(s.celular.replace(/\D/g,""))||(a.celular="Celular inválido"):a.celular="Celular é obrigatório",(s.senhaAtual||s.novaSenha||s.confirmNovaSenha)&&(s.senhaAtual||(a.senhaAtual="Senha atual é obrigatória para alterar senha"),s.novaSenha?s.novaSenha.length<6&&(a.novaSenha="Nova senha deve ter pelo menos 6 caracteres"):a.novaSenha="Nova senha é obrigatória",s.novaSenha!==s.confirmNovaSenha&&(a.confirmNovaSenha="Confirmação de senha não confere")),m(a),Object.keys(a).length===0}function d(a){let{name:l,value:u}=a.target;l&&l.includes("-")&&(l=l.split("-").map((r,i)=>i===0?r:r.charAt(0).toUpperCase()+r.slice(1)).join(""));let t=u;if(l==="celular"){const r=u.replace(/\D/g,"");let i="";r.length>0&&(i+="("+r.substring(0,2),r.length>=2&&(i+=") ",i+=r.substring(2,7)),r.length>7&&(i+="-"+r.substring(7,11))),t=i}p(r=>({...r,[l]:t})),n[l]&&m(r=>({...r,[l]:""}));try{A({target:{name:l,value:t}})}catch{}}async function T(){if(L()){if(s.senhaAtual)try{const a=f&&typeof f.getBaseUrl=="function"?f.getBaseUrl():typeof window<"u"&&window.__API_BASE?window.__API_BASE:"",l=await fetch(`${a}/api/auth/verify-password`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:o.email,senha:s.senhaAtual})});if(!l.ok){if(l.status===401){m(t=>({...t,senhaAtual:"Senha atual incorreta"}));return}m(t=>({...t,senhaAtual:"Erro ao verificar senha atual"}));return}const u=await l.json();if(!u||!u.success){m(t=>({...t,senhaAtual:"Senha atual incorreta"}));return}}catch{m(l=>({...l,senhaAtual:"Erro ao verificar senha atual"}));return}if(!o){alert("Erro: usuário não está logado");return}try{const a={nome:s.nome,email:s.email,celular:s.celular};s.novaSenha&&(a.novaSenha=s.novaSenha),o&&o.photoURL&&(a.photoURL=o.photoURL);const l=f&&typeof f.getBaseUrl=="function"?f.getBaseUrl():typeof window<"u"&&window.__API_BASE?window.__API_BASE:"";let u=null,t=!1;try{const c={"Content-Type":"application/json"};o&&o.access_token&&(c.Authorization=`Bearer ${o.access_token}`);const N=await fetch(`${l}/api/users/${encodeURIComponent(o.id)}`,{method:"PUT",headers:c,body:JSON.stringify(a)});if(N.ok){t=!0;const v=await N.json().catch(()=>null);v&&v.success&&v.user&&(u=v.user)}else console.warn("Profile save to server failed",N.status)}catch(c){console.warn("Profile save to server threw",c&&c.message?c.message:c)}const r=u?{...o,...u}:{...o,...s};U(r);const i={...r};i.senha&&delete i.senha,localStorage.setItem("usuario-logado",JSON.stringify(i));const M=JSON.parse(localStorage.getItem("usuarios")||"[]").map(c=>c.id===o.id?i:c);localStorage.setItem("usuarios",JSON.stringify(M)),p(c=>({...c,senhaAtual:"",novaSenha:"",confirmNovaSenha:""})),alert(t?"Dados salvos com sucesso!":"Alterações salvas apenas localmente (servidor indisponível). A senha não foi atualizada no servidor.");const j={...r};j.senha&&delete j.senha,P(j)}catch(a){alert("Erro ao salvar dados: "+a.message)}}}function B(){o&&p({nome:o.nome||"",celular:o.celular||"",email:o.email||"",senhaAtual:"",novaSenha:"",confirmNovaSenha:""}),m({});try{E()}catch{}}function I(){_(!g);try{k()}catch{}}return e.jsxs("div",{className:"login-form-card",children:[e.jsx("div",{children:e.jsx("h2",{className:"login-section-title",children:"Informações Pessoais"})}),e.jsxs("form",{className:"login-form",children:[e.jsxs("div",{className:"form-control w-full login-form-control",children:[e.jsx("input",{id:"nome",name:"nome",type:"text",value:s.nome,onChange:d,className:`input input-bordered w-full bg-white text-black ${n.nome?"error":""}`,placeholder:"Nome Completo",autoComplete:"name"}),n.nome&&e.jsx("span",{className:"error-message",children:n.nome})]}),e.jsxs("div",{className:"form-control w-full login-form-control",children:[e.jsx("input",{id:"celular",name:"celular",type:"tel",value:s.celular,onChange:d,className:`input input-bordered w-full bg-white text-black ${n.celular?"error":""}`,placeholder:"Celular",autoComplete:"tel"}),n.celular&&e.jsx("span",{className:"error-message",children:n.celular})]}),e.jsxs("div",{className:"form-control w-full login-form-control",children:[e.jsx("input",{id:"email",name:"email",type:"email",value:s.email,onChange:d,className:`input input-bordered w-full bg-white text-black ${n.email?"error":""}`,placeholder:"E-mail",autoComplete:"email"}),n.email&&e.jsx("span",{className:"error-message",children:n.email})]}),o&&(o.auth_id||o.providers&&o.providers.includes&&o.providers.includes("google"))&&e.jsx("div",{className:"form-control w-full login-form-control",style:{marginTop:6},children:e.jsxs("div",{style:{padding:"8px",borderRadius:6,background:"#f3f7ff",border:"1px solid #e0e7ff"},children:[e.jsx("strong",{children:"Conexões de conta:"}),e.jsxs("div",{style:{marginTop:6},children:["Google: ",e.jsx("span",{style:{fontWeight:700,color:"#1a73e8"},children:"Conectado"})]}),e.jsxs("div",{style:{marginTop:6,fontSize:13},children:["Se quiser desvincular a conta do Google, vá em ",e.jsx("a",{href:"/configuracoes",children:"Configurações"})," ou contate o suporte."]})]})}),e.jsxs("div",{className:"form-control w-full login-form-control",children:[e.jsxs("div",{className:"password-field",children:[e.jsx("input",{id:"senha-atual",name:"senha-atual",type:S?"text":"password",value:s.senhaAtual,onChange:d,className:`form-input password-input ${n.senhaAtual?"error":""}`,placeholder:"Senha atual",autoComplete:"current-password"}),e.jsx(C,{on:S,onClick:()=>$(a=>!a),ariaLabel:S?"Ocultar senha":"Mostrar senha"})]}),n.senhaAtual&&e.jsx("span",{className:"error-message",children:n.senhaAtual})]}),e.jsxs("div",{className:"form-control w-full login-form-control",children:[e.jsxs("div",{className:"password-field",children:[e.jsx("input",{id:"nova-senha",name:"nova-senha",type:g?"text":"password",value:s.novaSenha,onChange:d,className:`form-input password-input ${n.novaSenha?"error":""}`,placeholder:"Nova senha",autoComplete:"new-password"}),e.jsx(C,{on:g,onClick:I,ariaLabel:g?"Ocultar senha":"Mostrar senha"})]}),n.novaSenha&&e.jsx("span",{className:"error-message",children:n.novaSenha})]}),e.jsxs("div",{className:"form-control w-full login-form-control",children:[e.jsxs("div",{className:"password-field",children:[e.jsx("input",{id:"confirm-nova-senha",name:"confirm-nova-senha",type:w?"text":"password",value:s.confirmNovaSenha,onChange:d,className:`form-input password-input ${n.confirmNovaSenha?"error":""}`,placeholder:"Confirmar nova senha",autoComplete:"new-password"}),e.jsx(C,{on:w,onClick:()=>O(a=>!a),ariaLabel:w?"Ocultar senha":"Mostrar senha"})]}),n.confirmNovaSenha&&e.jsx("span",{className:"error-message",children:n.confirmNovaSenha})]}),e.jsxs("div",{className:"form-actions",children:[e.jsx("button",{type:"button",className:"btn login-submit",onClick:T,children:"Salvar"}),e.jsx("button",{type:"button",className:"btn btn-cancel",onClick:B,children:"Cancelar"})]})]})]})}function q(){const{usuarioLogado:x}=h.useContext(y)||{};return x?e.jsxs(e.Fragment,{children:[e.jsx(b,{}),e.jsx("div",{className:"page-wrapper menu-page",children:e.jsxs("div",{className:"page-content",id:"perfil",children:[e.jsx("h2",{className:"page-title",children:"Meu Perfil"}),e.jsx(R,{formData:x})]})})]}):e.jsxs(e.Fragment,{children:[e.jsx(b,{}),e.jsx("div",{className:"menu-page",children:e.jsxs("div",{className:"perfil-error",children:[e.jsx("h2",{className:"page-heading",children:"Acesso Negado"}),e.jsx("p",{children:"Você precisa estar logado para acessar esta página."})]})})]})}export{q as default};
