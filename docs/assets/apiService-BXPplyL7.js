import{g}from"./glossarioData-8VebtgBN.js";import{s as w,g as y}from"./mlService-Bx3cZaWs.js";class m{constructor(){this.isLocal=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1",this.getBaseUrl=()=>typeof window>"u"?"":window.__API_BASE?window.__API_BASE:window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"?`${window.location.protocol}//${window.location.hostname}:3001`:""}async fetchWithFallback(a,e=null){const r=this.getBaseUrl()+a;try{const o=await fetch(r);if(o.ok)return await o.json()}catch(o){console.warn(`API call failed for ${r}, falling back to local data:`,o)}if(e)return e;try{const o=this.getJsonFallbackPath(a);if(o){const s=await fetch(o);if(s.ok)return await s.json()}}catch(o){console.warn(`JSON fallback failed for ${a}:`,o)}return{data:[],message:"No data available"}}getJsonFallbackPath(a){return{"/api/glossario-dashboard":null,"/api/luzes-painel":"/data/luzes_painel.json","/api/pecas/meta":"/data/parts_db.json"}[a]||null}async getGlossarioDashboard(){return this.fetchWithFallback("/api/glossario-dashboard",g)}async getLuzesPainel(){try{const a=await fetch("/data/luzes_painel.json"),e=a.ok?await a.json():null;return this.fetchWithFallback("/api/luzes-painel",e)}catch{return this.fetchWithFallback("/api/luzes-painel")}}async getPecasMeta(){try{const a=await fetch("/data/parts_db.json");if(a.ok){const e=await a.json(),r=[...new Set(e.map(c=>c.category).filter(Boolean))].sort(),o=[...new Set(e.map(c=>c.manufacturer).filter(Boolean))].sort(),s=new Set,t=new Set,n=new Set;let p=0;return e.forEach(c=>{c.applications&&Array.isArray(c.applications)&&c.applications.forEach(i=>{if(p++,typeof i=="string"){const l=i.trim().split(/\s+/);if(l.length>=2){const d=l[0],h=l[1];n.add(d),s.add(`${d} ${h}`);const u=i.match(/\b(19|20)\d{2}\b/g);u&&u.forEach(f=>t.add(f))}}else typeof i=="object"&&(i.model&&s.add(i.model),i.year&&t.add(i.year),i.make&&n.add(i.make))})}),{grupos:r,pecas:e,marcas:[...n].sort(),modelos:[...s].sort(),anos:[...t].sort(),fabricantes:o}}}catch(a){console.warn("Error loading parts_db.json:",a)}return this.fetchWithFallback("/api/pecas/meta")}async filtrarPecas(a){if(this.isLocal)try{const e=await fetch("/api/pecas/filtrar",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(e.ok)return await e.json();console.warn("ApiService: API response not ok:",e.status)}catch(e){console.warn("API filter call failed, using local data:",e)}try{const e=await fetch("/data/parts_db.json");if(e.ok){let o=await e.json();if(a.grupo){const t=o.length;console.log("üîç Filtrando por grupo:",a.grupo),console.log("üìä Categorias dispon√≠veis:",[...new Set(o.map(n=>n.category))]),o=o.filter(n=>(console.log(`Comparando: "${n.category}" === "${a.grupo}"`,n.category===a.grupo),n.category===a.grupo)),console.log(`‚úÖ Filtrado: ${t} ‚Üí ${o.length} pe√ßas`)}const s=(a.peca||a.categoria||"").toString().toLowerCase().trim();return s&&(o=o.filter(t=>(t.name||"").toString().toLowerCase().trim()===s)),a.marca&&(o=o.filter(t=>t.applications&&t.applications.some(n=>typeof n=="string"?n.toLowerCase().includes(a.marca.toLowerCase()):!1))),a.modelo&&(o=o.filter(t=>t.applications&&t.applications.some(n=>typeof n=="string"?n.toLowerCase().includes(a.modelo.toLowerCase()):!1))),a.ano&&(o=o.filter(t=>t.applications&&t.applications.some(n=>typeof n=="string"?n.includes(a.ano):!1))),a.fabricante&&(o=o.filter(t=>t.manufacturer&&t.manufacturer.toLowerCase().includes(a.fabricante.toLowerCase()))),{pecas:o,total:o.length}}else console.error("ApiService: Failed to load /data/parts_db.json:",e.status)}catch(e){console.warn("Error filtering local data:",e)}return{pecas:[],total:0}}async getPecaById(a){if(this.isLocal)try{const e=await fetch(`/api/pecas/${a}`);if(e.ok)return await e.json()}catch(e){console.warn(`API call failed for piece ${a}, using local data:`,e)}try{const e=await fetch("/data/parts_detailed.json");if(e.ok){const s=(await e.json()).find(t=>t.id===a||t.id===parseInt(a)||t.id===String(a));if(s)return s}const r=await fetch("/data/parts_db.json");if(r.ok)return(await r.json()).find(t=>t.id===a||t.id===parseInt(a)||t.id===String(a))||{error:"Pe√ßa n√£o encontrada"}}catch(e){console.warn("Error finding piece in local data:",e)}return{error:"Pe√ßa n√£o encontrada"}}async buscarPecasML(a){try{const e=this.buildMLSearchQuery(a);if(!e)return console.warn("No search query built from filters, using local data"),this.filtrarPecas(a);console.log("üîç Buscando produtos no Mercado Livre:",e);const r=await w(e,{limit:50,offset:0});return r&&r.products&&r.products.length>0?(console.log(`‚úÖ Encontrados ${r.products.length} produtos no ML`),{pecas:r.products.map(this.convertMLProductToPeca),total:r.total,source:"mercado_livre",paging:r.paging}):(console.warn("Nenhum produto encontrado no ML, usando dados locais"),this.filtrarPecas(a))}catch(e){return console.error("Erro ao buscar no Mercado Livre, usando dados locais:",e),this.filtrarPecas(a)}}buildMLSearchQuery(a){const e=[];return a.categoria||a.peca?e.push(a.categoria||a.peca):a.grupo&&e.push(a.grupo),a.marca&&e.push(a.marca),a.modelo&&e.push(a.modelo),a.ano&&e.push(a.ano),a.fabricante&&e.push(a.fabricante),e.join(" ").trim()||null}convertMLProductToPeca(a){return{id:a.id,name:a.title,category:a.category_id||"Pe√ßas Automotivas",manufacturer:a.seller?.nickname||"Mercado Livre",price:a.price,currency:a.currency_id||"BRL",condition:a.condition,thumbnail:a.thumbnail,pictures:a.pictures||[],permalink:a.permalink,available_quantity:a.available_quantity||0,sold_quantity:a.sold_quantity||0,shipping:{free_shipping:a.shipping?.free_shipping||!1,store_pick_up:a.shipping?.store_pick_up||!1},attributes:a.attributes||[],ml_product:!0,ml_id:a.id,original_price:a.original_price,listing_type_id:a.listing_type_id,applications:this.extractApplicationsFromMLProduct(a)}}extractApplicationsFromMLProduct(a){const e=[];if(a.attributes&&Array.isArray(a.attributes)){const r=a.attributes.find(t=>t.id==="BRAND"||t.id==="VEHICLE_BRAND"),o=a.attributes.find(t=>t.id==="MODEL"||t.id==="VEHICLE_MODEL"),s=a.attributes.find(t=>t.id==="VEHICLE_YEAR");if(r||o||s){const t=[r?.value_name,o?.value_name,s?.value_name].filter(Boolean).join(" ");t&&e.push(t)}}return e}async getPecaByIdML(a){try{console.log("üîç Buscando detalhes do produto ML:",a);const e=await y(a);return e?this.convertMLProductToPeca(e):this.getPecaById(a)}catch(e){return console.error("Erro ao buscar detalhes no ML, usando dados locais:",e),this.getPecaById(a)}}}const M=new m;export{M as a};
