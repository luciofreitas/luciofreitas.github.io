import{r as l,u as L,A as $,j as e,M as D,T as U,s as h}from"./index-Ocr0OBBm.js";function J(){const[v,g]=l.useState(""),[c,S]=l.useState(""),[m,w]=l.useState(""),[_,b]=l.useState(""),[N,B]=l.useState(!1),[y,k]=l.useState(!1),[r,p]=l.useState({}),[E,x]=l.useState(""),j=L(),{setUsuarioLogado:f}=l.useContext($||{}),C=s=>{try{const n=["#F44336","#E91E63","#9C27B0","#673AB7","#3F51B5","#2196F3","#03A9F4","#00BCD4","#009688","#4CAF50","#8BC34A","#CDDC39","#FFEB3B","#FFC107","#FF9800","#FF5722"],i=String(s||"").trim()||"user";let t=0;for(let a=0;a<i.length;a++)t=(t<<5)-t+i.charCodeAt(a),t|=0;return n[Math.abs(t)%n.length]}catch{return"#2196F3"}},z=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;function O(){const s={};return(!v||!v.trim())&&(s.nome="Nome é obrigatório."),!c||!c.trim()?s.email="E-mail é obrigatório.":z.test(c)||(s.email="E-mail inválido."),m?m.length<6&&(s.senha="Senha deve ter pelo menos 6 caracteres."):s.senha="Senha é obrigatória.",m!==_&&(s.confirmSenha="As senhas não conferem."),p(s),Object.keys(s).length===0}function I(s){if(s.preventDefault(),x(""),!O())return;const n=String(v||"").trim().replace(/\s+/g," ");(async()=>{try{const i=window.__API_BASE||"",t=await fetch(`${i}/api/users`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nome:n,email:c.trim(),senha:m})});if(t.status===201){const a=await t.json().catch(()=>({})),d={id:a.id||`local_${Date.now()}`,email:a.email||c.trim(),nome:a.nome||a.name?String(a.nome||a.name).trim():n,name:a.nome||a.name?String(a.nome||a.name).trim():n,avatarBg:C(a.nome||a.name?String(a.nome||a.name).trim():n),photoURL:a.photoURL||a.photo_url||null};try{f&&f(d)}catch{}try{localStorage.setItem("usuario-logado",JSON.stringify(d))}catch{}x("Cadastro realizado com sucesso! Entrando..."),window.showToast&&window.showToast("Cadastro realizado com sucesso! Entrando...","success",1200),setTimeout(()=>{try{j("/buscar-pecas")}catch{}},1e3),g(""),S(""),w(""),b(""),p({});return}if(t.status===409){const a=await t.json().catch(()=>({}));p({form:"Usuário já existe. Tente recuperar a senha ou entre em contato."}),console.warn("User exists:",a);return}console.warn("API /api/users returned non-201 status, attempting Supabase signup fallback",t.status);try{const a=c.trim(),d=m;if(h&&h.auth&&typeof h.auth.signUp=="function"){const{data:u,error:F}=await h.auth.signUp({email:a,password:d,options:{data:{nome:n}}});if(F)console.warn("Supabase signup fallback failed:",F);else if(u&&(u.user||u)){const o=u.user||u,T={id:o.id||o.user?.id||`local_${Date.now()}`,email:o.email||a,nome:o.user_metadata&&(o.user_metadata.nome||o.user_metadata.name)?o.user_metadata.nome||o.user_metadata.name:n,name:o.user_metadata&&(o.user_metadata.nome||o.user_metadata.name)?o.user_metadata.nome||o.user_metadata.name:n,avatarBg:C(o.user_metadata&&(o.user_metadata.nome||o.user_metadata.name)?o.user_metadata.nome||o.user_metadata.name:n),photoURL:o.photoURL||o.avatar_url||null};try{f&&f(T)}catch{}try{localStorage.setItem("usuario-logado",JSON.stringify(T))}catch{}x("Cadastro realizado (Supabase). Entrando..."),window.showToast&&window.showToast("Cadastro realizado (Supabase).","success",1200),setTimeout(()=>{try{j("/buscar-pecas")}catch{}},1e3),g(""),S(""),w(""),b(""),p({});return}}}catch(a){console.warn("Supabase signup fallback threw:",a&&a.message?a.message:a)}console.warn("Falling back to localStorage after API + Supabase attempts failed")}catch(i){console.warn("Failed to call /api/users, attempting Supabase signup fallback",i&&i.message);try{if(h&&h.auth&&typeof h.auth.signUp=="function"){const{data:t,error:a}=await h.auth.signUp({email:c.trim(),password:m});if(!a&&t&&(t.user||t)){x("Cadastro realizado (Supabase). Redirecionando para o login..."),window.showToast&&window.showToast("Cadastro realizado (Supabase).","success",2e3),setTimeout(()=>{try{j("/login",{state:{email:c.trim()}})}catch{}},1500),g(""),S(""),w(""),b(""),p({});return}console.warn("Supabase signup fallback returned error",a)}}catch(t){console.warn("Supabase signup fallback threw:",t&&t.message?t.message:t)}}try{const i="usuarios",t=JSON.parse(localStorage.getItem(i)||"[]"),a={id:`local_${Date.now()}`,nome:n,email:c.trim(),senha:m,criadoEm:new Date().toISOString(),avatarBg:C(n)};t.push(a),localStorage.setItem(i,JSON.stringify(t));try{f&&f(a)}catch{}try{localStorage.setItem("usuario-logado",JSON.stringify(a))}catch{}x("Cadastro (local) realizado com sucesso! Entrando..."),window.showToast&&window.showToast("Cadastro realizado (local). Entrando...","success",1200),setTimeout(()=>{try{j("/buscar-pecas")}catch{}},1e3),g(""),S(""),w(""),b(""),p({})}catch(i){p({form:"Erro ao salvar os dados localmente. Verifique o console."}),console.error("Erro salvando usuário localmente:",i)}})()}return e.jsxs(e.Fragment,{children:[e.jsx(D,{}),e.jsx("div",{className:"page-wrapper",children:e.jsx("div",{className:"page-content",children:e.jsx("div",{className:"cadastro-card-outer",children:e.jsxs("div",{className:"cadastro-card-grid",children:[e.jsxs("section",{className:"cadastro-card",children:[e.jsx("h1",{className:"cadastro-title",children:"Cadastro"}),e.jsx("p",{className:"cadastro-sub",children:"Crie sua conta para acessar recursos adicionais"}),e.jsxs("form",{className:"cadastro-form",onSubmit:I,noValidate:!0,children:[r.form&&e.jsx("div",{className:"form-error",children:r.form}),e.jsxs("label",{className:"field",children:[e.jsx("span",{className:"label",children:"Nome completo"}),e.jsx("input",{className:`input ${r.nome?"input-error":""}`,type:"text",value:v,onChange:s=>g(s.target.value),placeholder:"Seu nome","aria-invalid":!!r.nome,"aria-describedby":r.nome?"err-nome":void 0}),r.nome&&e.jsx("div",{id:"err-nome",className:"error",children:r.nome})]}),e.jsxs("label",{className:"field",children:[e.jsx("span",{className:"label",children:"E-mail"}),e.jsx("input",{className:`input ${r.email?"input-error":""}`,type:"email",value:c,onChange:s=>S(s.target.value),placeholder:"seu@exemplo.com","aria-invalid":!!r.email,"aria-describedby":r.email?"err-email":void 0}),r.email&&e.jsx("div",{id:"err-email",className:"error",children:r.email})]}),e.jsxs("label",{className:"field",children:[e.jsx("span",{className:"label",children:"Senha"}),e.jsxs("div",{className:"password-field",children:[e.jsx("input",{className:`input password-input ${r.senha?"input-error":""}`,type:N?"text":"password",value:m,onChange:s=>w(s.target.value),placeholder:"Crie uma senha","aria-invalid":!!r.senha,"aria-describedby":r.senha?"err-senha":void 0}),e.jsx(U,{on:N,onClick:()=>B(s=>!s),ariaLabel:N?"Ocultar senha":"Mostrar senha"})]}),r.senha&&e.jsx("div",{id:"err-senha",className:"error",children:r.senha})]}),e.jsxs("label",{className:"field field-password",children:[e.jsx("span",{className:"label",children:"Confirmar senha"}),e.jsxs("div",{className:"password-field",children:[e.jsx("input",{className:`input password-input ${r.confirmSenha?"input-error":""}`,type:y?"text":"password",value:_,onChange:s=>b(s.target.value),placeholder:"Repita a senha","aria-invalid":!!r.confirmSenha,"aria-describedby":r.confirmSenha?"err-confirm":void 0}),e.jsx(U,{on:y,onClick:()=>k(s=>!s),ariaLabel:y?"Ocultar senha":"Mostrar senha"})]}),r.confirmSenha&&e.jsx("div",{id:"err-confirm",className:"error",children:r.confirmSenha})]}),e.jsx("button",{className:"submit",type:"submit",children:"Criar conta"}),E&&e.jsx("div",{className:"success",children:E})]})]}),e.jsx("div",{className:"cadastro-right","aria-hidden":"true",children:e.jsx("div",{className:"cadastro-hero",role:"img","aria-label":"Imagem ilustrativa de peças automotivas"})})]})})})})]})}export{J as default};
