import{r as u}from"./index-DzmNS6o_.js";import{a as g}from"./glossarioData-8VebtgBN.js";const w=r=>{const[y,d]=u.useState(g),[c,p]=u.useState({}),v=`votosGuias_${r||"guest"}`;return u.useEffect(()=>{try{const a=JSON.parse(localStorage.getItem(v)||"{}"),e=JSON.parse(localStorage.getItem("avaliacoesGuias")||"{}");p(a),d(l=>({...l,...e}))}catch(a){console.warn("[useAvaliacoes] failed to parse stored votes/avaliacoes",a)}},[v]),{avaliacoes:y,votosUsuario:c,avaliarGuia:(a,e)=>{const l=c&&Object.prototype.hasOwnProperty.call(c,a)?c[a]:null;d(t=>{const s=t[a]||{total:0,soma:0};let o=s.total,n=s.soma;l==null?(o=s.total+1,n=s.soma+e):n=s.soma-Number(l)+Number(e);const i=o>0?n/o:0,m={...t,[a]:{total:o,soma:n,media:Number(i.toFixed(1))}};try{localStorage.setItem("avaliacoesGuias",JSON.stringify(m))}catch(S){console.warn("[useAvaliacoes] failed to save avaliacoes to localStorage",S)}return m});const f={...c,[a]:e};p(f);try{localStorage.setItem(v,JSON.stringify(f))}catch(t){console.warn("[useAvaliacoes] failed to save votos to localStorage",t)}(async()=>{try{console.debug("[useAvaliacoes] POST vote",{guiaId:a,estrelas:e,previous:l});const t=typeof window<"u"&&window.__API_BASE?window.__API_BASE:"",s=`${t}/api/guias/${encodeURIComponent(a)}/ratings`;let o=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userEmail:r||null,rating:e})});const n=o.headers.get("content-type")||"";if(o.status===404||/text\/.+html/i.test(n)){console.debug("[useAvaliacoes] path-based POST failed or returned HTML, trying body-based fallback");const i=`${t}/api/guias/ratings`;o=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({guiaId:a,userEmail:r||null,rating:e})})}if(!o.ok){const i=await o.text().catch(()=>"<no body>");console.warn("[useAvaliacoes] backend rating failed",o.status,i)}}catch(t){console.warn("[useAvaliacoes] failed to POST rating to backend, keeping local fallback:",t)}})()}}};export{w as u};
