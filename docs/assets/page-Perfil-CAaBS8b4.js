import{r as h,A,j as e,T as b}from"./index-mXQJmD7s.js";import{M as y}from"./index.esm-R4PuJKBP.js";import{a as d}from"./apiService-DRkEcca-.js";import"./glossarioData-8VebtgBN.js";function F({formData:w={},onChange:_=()=>{},onSave:k=()=>{},onCancel:P=()=>{},showPassword:M=!1,onToggleShowPassword:U=()=>{}}){const{usuarioLogado:s,setUsuarioLogado:C}=h.useContext(A)||{},[n,p]=h.useState({nome:"",celular:"",email:"",senhaAtual:"",novaSenha:"",confirmNovaSenha:""}),[g,E]=h.useState(!1),[x,B]=h.useState(!1),[S,I]=h.useState(!1),[l,m]=h.useState({});h.useEffect(()=>{s&&(p({nome:s.nome||"",celular:s.celular||"",email:s.email||"",senhaAtual:"",novaSenha:"",confirmNovaSenha:""}),(async()=>{try{const r=d&&typeof d.getBaseUrl=="function"?d.getBaseUrl():typeof window<"u"&&window.__API_BASE?window.__API_BASE:"",c=s.auth_id||s.id;console.log("üîç Fetching user data from backend:",{base:r,userId:c});const i=await fetch(`${r}/api/users/${encodeURIComponent(c)}`);if(i.ok){const a=await i.json();console.log("üîç Backend user data received:",a),a.success&&a.user&&(p(t=>({...t,nome:a.user.nome||a.user.name||t.nome,celular:a.user.celular||a.user.telefone||a.user.phone||t.celular,email:a.user.email||t.email})),a.user.celular&&!s.celular&&C(t=>({...t,celular:a.user.celular,telefone:a.user.celular,phone:a.user.celular})))}else console.warn("Failed to fetch user data from backend:",i.status)}catch(r){console.warn("Error fetching user data from backend:",r)}})())},[s]);function $(){const o={};return n.nome.trim()||(o.nome="Nome √© obrigat√≥rio"),n.email.trim()?/^\S+@\S+\.\S+$/.test(n.email)||(o.email="E-mail inv√°lido"):o.email="E-mail √© obrigat√≥rio",n.celular.trim()?/^\d{8,}$/.test(n.celular.replace(/\D/g,""))||(o.celular="Celular inv√°lido"):o.celular="Celular √© obrigat√≥rio",(n.senhaAtual||n.novaSenha||n.confirmNovaSenha)&&(n.senhaAtual||(o.senhaAtual="Senha atual √© obrigat√≥ria para alterar senha"),n.novaSenha?n.novaSenha.length<6&&(o.novaSenha="Nova senha deve ter pelo menos 6 caracteres"):o.novaSenha="Nova senha √© obrigat√≥ria",n.novaSenha!==n.confirmNovaSenha&&(o.confirmNovaSenha="Confirma√ß√£o de senha n√£o confere")),m(o),Object.keys(o).length===0}function f(o){let{name:r,value:c}=o.target;r&&r.includes("-")&&(r=r.split("-").map((a,t)=>t===0?a:a.charAt(0).toUpperCase()+a.slice(1)).join(""));let i=c;if(r==="celular"){const a=c.replace(/\D/g,"");let t="";a.length>0&&(t+="("+a.substring(0,2),a.length>=2&&(t+=") ",t+=a.substring(2,7)),a.length>7&&(t+="-"+a.substring(7,11))),i=t}p(a=>({...a,[r]:i})),l[r]&&m(a=>({...a,[r]:""}));try{_({target:{name:r,value:i}})}catch{}}async function O(){if($()){if(n.senhaAtual)try{const o=d&&typeof d.getBaseUrl=="function"?d.getBaseUrl():typeof window<"u"&&window.__API_BASE?window.__API_BASE:"",r=await fetch(`${o}/api/auth/verify-password`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s.email,senha:n.senhaAtual})});if(!r.ok){if(r.status===401){m(i=>({...i,senhaAtual:"Senha atual incorreta"}));return}m(i=>({...i,senhaAtual:"Erro ao verificar senha atual"}));return}const c=await r.json();if(!c||!c.success){m(i=>({...i,senhaAtual:"Senha atual incorreta"}));return}}catch{m(r=>({...r,senhaAtual:"Erro ao verificar senha atual"}));return}if(!s){alert("Erro: usu√°rio n√£o est√° logado");return}try{const o={nome:n.nome,email:n.email,celular:n.celular};n.novaSenha&&(o.novaSenha=n.novaSenha),s&&s.photoURL&&(o.photoURL=s.photoURL);const r=d&&typeof d.getBaseUrl=="function"?d.getBaseUrl():typeof window<"u"&&window.__API_BASE?window.__API_BASE:"";let c=null,i=!1;try{const u={"Content-Type":"application/json"};s&&s.access_token&&(u.Authorization=`Bearer ${s.access_token}`);const R=s.auth_id||s.id,N=await fetch(`${r}/api/users/${encodeURIComponent(R)}`,{method:"PUT",headers:u,body:JSON.stringify(o)});if(N.ok){i=!0;const v=await N.json().catch(()=>null);v&&v.success&&v.user&&(c=v.user)}else console.warn("Profile save to server failed",N.status)}catch(u){console.warn("Profile save to server threw",u&&u.message?u.message:u)}const a=c?{...s,...c}:{...s,...n};C(a);const t={...a};t.senha&&delete t.senha,localStorage.setItem("usuario-logado",JSON.stringify(t));const D=JSON.parse(localStorage.getItem("usuarios")||"[]").map(u=>u.id===s.id?t:u);localStorage.setItem("usuarios",JSON.stringify(D)),p(u=>({...u,senhaAtual:"",novaSenha:"",confirmNovaSenha:""})),alert(i?"Dados salvos com sucesso!":"Altera√ß√µes salvas apenas localmente (servidor indispon√≠vel). A senha n√£o foi atualizada no servidor.");const j={...a};j.senha&&delete j.senha,k(j)}catch(o){alert("Erro ao salvar dados: "+o.message)}}}function L(){s&&p({nome:s.nome||"",celular:s.celular||"",email:s.email||"",senhaAtual:"",novaSenha:"",confirmNovaSenha:""}),m({});try{P()}catch{}}function T(){E(!g);try{U()}catch{}}return e.jsxs("div",{className:"login-form-card",children:[e.jsx("div",{children:e.jsx("h2",{className:"login-section-title",children:"Informa√ß√µes Pessoais"})}),e.jsxs("form",{className:"login-form",children:[e.jsxs("div",{className:"form-control w-full login-form-control",children:[e.jsx("input",{id:"nome",name:"nome",type:"text",value:n.nome,onChange:f,className:`input input-bordered w-full bg-white text-black ${l.nome?"error":""}`,placeholder:"Nome Completo",autoComplete:"name"}),l.nome&&e.jsx("span",{className:"error-message",children:l.nome})]}),e.jsxs("div",{className:"form-control w-full login-form-control",children:[e.jsx("input",{id:"celular",name:"celular",type:"tel",value:n.celular,onChange:f,className:`input input-bordered w-full bg-white text-black ${l.celular?"error":""}`,placeholder:"Celular",autoComplete:"tel"}),l.celular&&e.jsx("span",{className:"error-message",children:l.celular})]}),e.jsxs("div",{className:"form-control w-full login-form-control",children:[e.jsx("input",{id:"email",name:"email",type:"email",value:n.email,onChange:f,className:`input input-bordered w-full bg-white text-black ${l.email?"error":""}`,placeholder:"E-mail",autoComplete:"email"}),l.email&&e.jsx("span",{className:"error-message",children:l.email})]}),s&&(s.auth_id||s.providers&&s.providers.includes&&s.providers.includes("google"))&&e.jsx("div",{className:"form-control w-full login-form-control",style:{marginTop:6},children:e.jsxs("div",{style:{padding:"8px",borderRadius:6,background:"#f3f7ff",border:"1px solid #e0e7ff"},children:[e.jsx("strong",{children:"Conex√µes de conta:"}),e.jsxs("div",{style:{marginTop:6},children:["Google: ",e.jsx("span",{style:{fontWeight:700,color:"#1a73e8"},children:"Conectado"})]}),e.jsxs("div",{style:{marginTop:6,fontSize:13},children:["Se quiser desvincular a conta do Google, v√° em ",e.jsx("a",{href:"/#/configuracoes",children:"Configura√ß√µes"})," ou contate o suporte."]})]})}),e.jsxs("div",{className:"form-control w-full login-form-control",children:[e.jsxs("div",{className:"password-field",children:[e.jsx("input",{id:"senha-atual",name:"senha-atual",type:x?"text":"password",value:n.senhaAtual,onChange:f,className:`form-input password-input ${l.senhaAtual?"error":""}`,placeholder:"Senha atual",autoComplete:"current-password"}),e.jsx(b,{on:x,onClick:()=>B(o=>!o),ariaLabel:x?"Ocultar senha":"Mostrar senha"})]}),l.senhaAtual&&e.jsx("span",{className:"error-message",children:l.senhaAtual})]}),e.jsxs("div",{className:"form-control w-full login-form-control",children:[e.jsxs("div",{className:"password-field",children:[e.jsx("input",{id:"nova-senha",name:"nova-senha",type:g?"text":"password",value:n.novaSenha,onChange:f,className:`form-input password-input ${l.novaSenha?"error":""}`,placeholder:"Nova senha",autoComplete:"new-password"}),e.jsx(b,{on:g,onClick:T,ariaLabel:g?"Ocultar senha":"Mostrar senha"})]}),l.novaSenha&&e.jsx("span",{className:"error-message",children:l.novaSenha})]}),e.jsxs("div",{className:"form-control w-full login-form-control",children:[e.jsxs("div",{className:"password-field",children:[e.jsx("input",{id:"confirm-nova-senha",name:"confirm-nova-senha",type:S?"text":"password",value:n.confirmNovaSenha,onChange:f,className:`form-input password-input ${l.confirmNovaSenha?"error":""}`,placeholder:"Confirmar nova senha",autoComplete:"new-password"}),e.jsx(b,{on:S,onClick:()=>I(o=>!o),ariaLabel:S?"Ocultar senha":"Mostrar senha"})]}),l.confirmNovaSenha&&e.jsx("span",{className:"error-message",children:l.confirmNovaSenha})]}),e.jsxs("div",{className:"form-actions",children:[e.jsx("button",{type:"button",className:"btn login-submit",onClick:O,children:"Salvar"}),e.jsx("button",{type:"button",className:"btn btn-cancel",onClick:L,children:"Cancelar"})]})]})]})}function W(){const{usuarioLogado:w}=h.useContext(A)||{};return w?e.jsxs(e.Fragment,{children:[e.jsx(y,{}),e.jsx("div",{className:"site-header-spacer"}),e.jsx("div",{className:"page-wrapper menu-page",children:e.jsxs("div",{className:"page-content",id:"perfil",children:[e.jsx("h2",{className:"page-title",children:"Meu Perfil"}),e.jsx(F,{formData:w})]})})]}):e.jsxs(e.Fragment,{children:[e.jsx(y,{}),e.jsx("div",{className:"site-header-spacer"}),e.jsx("div",{className:"menu-page",children:e.jsxs("div",{className:"perfil-error",children:[e.jsx("h2",{className:"page-heading",children:"Acesso Negado"}),e.jsx("p",{children:"Voc√™ precisa estar logado para acessar esta p√°gina."})]})})]})}export{W as default};
