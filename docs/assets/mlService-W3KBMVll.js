const s="https://luciofreitas-github-io.onrender.com ?",E=async r=>{try{if(!r)throw new Error("userId is required");const e=await fetch(`${s}/api/ml/auth?userId=${encodeURIComponent(r)}`);if(!e.ok){const c=await e.json();throw new Error(c.error||"Failed to initiate ML auth")}const t=await e.json();t.state&&sessionStorage.setItem("ml_oauth_state",t.state),window.location.href=t.authUrl}catch(e){throw console.error("Error initiating ML auth:",e),e}},L=async()=>{try{const r=p();if(r&&r.accessToken)try{await fetch(`${s}/api/ml/revoke`,{method:"POST",headers:{Authorization:`Bearer ${r.accessToken}`}})}catch(e){console.warn("Failed to revoke ML token:",e)}w()}catch(r){throw console.error("Error disconnecting ML:",r),w(),r}},k=()=>{const r=p();return!r||!r.accessToken?{connected:!1,expired:!1}:{connected:!0,expired:r.expiresAt&&Date.now()>r.expiresAt,connectedAt:r.connectedAt,expiresAt:r.expiresAt,userId:r.userId}},p=()=>{try{const r=localStorage.getItem("ml_token_data");return r?JSON.parse(r):null}catch(r){return console.error("Error parsing stored ML tokens:",r),null}},w=()=>{localStorage.removeItem("ml_token_data"),sessionStorage.removeItem("ml_oauth_state"),console.log("ML tokens cleared")};let o=null,a=0;const f=3e4,d=3,m=3e5,A=async(r,e={})=>{try{const t=a>=d?m:f;if(o&&Date.now()-o<t){const l=Math.ceil((t-(Date.now()-o))/1e3);throw console.warn(`â¸ï¸ ML API em cooldown. Tentando novamente em ${l}s. Usando dados locais.`),new Error("ML API temporarily unavailable, using local data")}if(!r)throw new Error("Search query is required");const{limit:c=50,offset:g=0,category:u}=e,h=new URLSearchParams({q:r,limit:c.toString(),offset:g.toString()});u&&h.set("category",u);const i=await fetch(`${s}/api/ml/products/search?${h.toString()}`);if(!i.ok){o=Date.now(),a++;const l=await i.json().catch(()=>({error:"API error"}));throw a>=d?console.error(`ðŸ”´ ML API falhou ${a} vezes consecutivas. Pausando por 5 minutos.`):console.warn(`âš ï¸ ML API erro ${a}/${d}. Pausando por 30s.`),new Error(l.error||"Failed to search products")}o=null,a=0;const n=await i.json();return{products:n.results||[],total:n.total||0,paging:n.paging||{},filters:n.filters||[],availableFilters:n.available_filters||[]}}catch(t){throw console.error("Error searching ML products:",t),t}},D=async r=>{try{if(o&&Date.now()-o<f)throw new Error("ML API temporarily unavailable");if(!r)throw new Error("Product ID is required");const e=await fetch(`${s}/api/ml/products/${r}`);if(!e.ok){o=Date.now();const t=await e.json().catch(()=>({error:"API error"}));throw new Error(t.error||"Failed to get product details")}return o=null,await e.json()}catch(e){throw console.error("Error getting ML product details:",e),e}};export{k as a,L as d,D as g,E as i,A as s};
