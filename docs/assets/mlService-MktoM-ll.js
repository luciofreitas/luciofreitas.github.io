const s="http://localhost:3001",p=async r=>{try{if(!r)throw new Error("userId is required");const t=await fetch(`${s}/api/ml/auth?userId=${encodeURIComponent(r)}`);if(!t.ok){const n=await t.json();throw new Error(n.error||"Failed to initiate ML auth")}const e=await t.json();e.state&&sessionStorage.setItem("ml_oauth_state",e.state),window.location.href=e.authUrl}catch(t){throw console.error("Error initiating ML auth:",t),t}},g=async()=>{try{const r=h();if(r&&r.accessToken)try{await fetch(`${s}/api/ml/revoke`,{method:"POST",headers:{Authorization:`Bearer ${r.accessToken}`}})}catch(t){console.warn("Failed to revoke ML token:",t)}d()}catch(r){throw console.error("Error disconnecting ML:",r),d(),r}},f=()=>{const r=h();return!r||!r.accessToken?{connected:!1,expired:!1}:{connected:!0,expired:r.expiresAt&&Date.now()>r.expiresAt,connectedAt:r.connectedAt,expiresAt:r.expiresAt,userId:r.userId}},h=()=>{try{const r=localStorage.getItem("ml_token_data");return r?JSON.parse(r):null}catch(r){return console.error("Error parsing stored ML tokens:",r),null}},d=()=>{localStorage.removeItem("ml_token_data"),sessionStorage.removeItem("ml_oauth_state"),console.log("ML tokens cleared")};let o=null;const u=3e4,m=async(r,t={})=>{try{if(o&&Date.now()-o<u)throw new Error("ML API temporarily unavailable, using local data");if(!r)throw new Error("Search query is required");const{limit:e=50,offset:n=0,category:i}=t,l=new URLSearchParams({q:r,limit:e.toString(),offset:n.toString()});i&&l.set("category",i);const c=await fetch(`${s}/api/ml/products/search?${l.toString()}`);if(!c.ok){o=Date.now();const w=await c.json().catch(()=>({error:"API error"}));throw new Error(w.error||"Failed to search products")}o=null;const a=await c.json();return{products:a.results||[],total:a.total||0,paging:a.paging||{},filters:a.filters||[],availableFilters:a.available_filters||[]}}catch(e){throw console.error("Error searching ML products:",e),e}},k=async r=>{try{if(o&&Date.now()-o<u)throw new Error("ML API temporarily unavailable");if(!r)throw new Error("Product ID is required");const t=await fetch(`${s}/api/ml/products/${r}`);if(!t.ok){o=Date.now();const e=await t.json().catch(()=>({error:"API error"}));throw new Error(e.error||"Failed to get product details")}return o=null,await t.json()}catch(t){throw console.error("Error getting ML product details:",t),t}};export{f as a,g as d,k as g,p as i,m as s};
