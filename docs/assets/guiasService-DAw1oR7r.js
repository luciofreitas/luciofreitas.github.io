const d="user_custom_guias";class g{constructor(){this.guias=[]}async loadGuias(){try{const t=typeof window<"u"&&window.__API_BASE||(typeof window<"u"&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")?`${window.location.protocol}//${window.location.hostname}:3001`:""),a=`${t}/api/guias`;console.debug("[guiasService] loadGuias: baseUrl=",t),console.debug("[guiasService] loadGuias: attempting fetch",a);const i=await fetch(a);if(console.debug("[guiasService] loadGuias: response status",i.status),i.ok){const e=await i.json(),s=new Set(e.map(o=>o.id)),n=(this.guias||[]).filter(o=>!s.has(o.id));return this.guias=[...n,...e],console.debug("[guiasService] loadGuias: received",this.guias&&this.guias.length,"items",this.guias.map(o=>o.id).slice(0,10)),this.saveGuias(),this.guias}else{let e="";try{e=await i.text()}catch{e="<failed to read response text>"}console.warn("[guiasService] loadGuias: non-ok response",i.status,i.statusText,e)}}catch(t){console.warn("API loadGuias failed, falling back to localStorage:",t)}try{const t=localStorage.getItem(d);if(t)return this.guias=JSON.parse(t),this.guias}catch(t){console.error("Erro ao ler localStorage de guias:",t)}if(this.guias&&this.guias.length)return this.guias;try{const a=await fetch("/data/guias.json");if(a.ok)return this.guias=await a.json(),this.guias}catch(t){console.warn("JSON fallback for guias not available:",t)}return this.guias=this.guias||[],this.guias}saveGuias(){try{localStorage.setItem(d,JSON.stringify(this.guias))}catch(t){console.error("Erro ao salvar guias:",t)}}async createGuia(t,a){const i={id:`guia_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,autorEmail:a,titulo:t.titulo,descricao:t.descricao,categoria:t.categoria,conteudo:t.conteudo,imagem:t.imagem||null,criadoEm:new Date().toISOString(),atualizadoEm:new Date().toISOString(),ratings:[],status:"ativo",views:0};this.guias=this.guias||[],this.guias.unshift(i),this.saveGuias();try{const s=`${typeof window<"u"&&window.__API_BASE||(typeof window<"u"&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")?`${window.location.protocol}//${window.location.hostname}:3001`:"")}/api/guias`;console.debug("[guiasService] createGuia: POST",s,i);const n=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(console.debug("[guiasService] createGuia: response status",n.status),n.ok){const o=await n.json();return console.debug("[guiasService] createGuia: created remote",o),await this.loadGuias(),o.guia||i}else console.warn("[guiasService] createGuia: non-ok response",n.status,n.statusText)}catch(e){console.warn("API createGuia failed (optimistic local saved):",e)}return i}async updateGuia(t,a,i){const e=this.guias.findIndex(o=>o.id===t);if(e===-1)throw new Error("Guia não encontrado");const s=this.guias[e];if(s.autorEmail!==i)throw new Error("Apenas o autor pode editar este guia");const n={...s,titulo:a.titulo||s.titulo,descricao:a.descricao||s.descricao,categoria:a.categoria||s.categoria,conteudo:a.conteudo||s.conteudo,imagem:a.imagem!==void 0?a.imagem:s.imagem,atualizadoEm:new Date().toISOString(),status:"ativo"};try{const o=typeof window<"u"&&window.__API_BASE||(typeof window<"u"&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")?`${window.location.protocol}//${window.location.hostname}:3001`:"");if((await fetch(`${o}/api/guias/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})).ok)return await this.loadGuias(),n}catch(o){console.warn("API updateGuia failed, falling back to localStorage:",o)}return this.guias[e]=n,this.saveGuias(),this.guias[e]}async deleteGuia(t,a){const i=this.guias.find(e=>e.id===t);if(!i)throw new Error("Guia não encontrado");if(i.autorEmail!==a)throw new Error("Apenas o autor pode deletar este guia");try{const e=typeof window<"u"&&window.__API_BASE||(typeof window<"u"&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")?`${window.location.protocol}//${window.location.hostname}:3001`:"");if((await fetch(`${e}/api/guias/${t}`,{method:"DELETE"})).ok)return await this.loadGuias(),!0}catch(e){console.warn("API deleteGuia failed, falling back to localStorage:",e)}return this.guias=this.guias.filter(e=>e.id!==t),this.saveGuias(),!0}async addRating(t,a,i){const e=typeof window<"u"&&window.__API_BASE||(typeof window<"u"&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")?`${window.location.protocol}//${window.location.hostname}:3001`:"");try{if(e){const o=await fetch(`${e}/api/guias/${encodeURIComponent(t)}/ratings`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userEmail:a,rating:i})});if(o.ok){const r=await o.json(),c=this.guias.findIndex(u=>u.id===t);if(c!==-1)return r&&r.ratings&&(this.guias[c]._ratingAggregate={total:Number(r.ratings.total||0),average:Number(r.ratings.average||0)}),this.saveGuias(),this.guias[c];await this.loadGuias();const l=this.guias.find(u=>u.id===t);return l||{id:t,_ratingAggregate:r&&r.ratings?{total:Number(r.ratings.total||0),average:Number(r.ratings.average||0)}:null}}}}catch(o){console.warn("API addRating failed, falling back to local:",o)}const s=this.guias.findIndex(o=>o.id===t);if(s===-1)throw new Error("Guia não encontrado");const n=this.guias[s];return n.ratings=(n.ratings||[]).filter(o=>o.userEmail!==a),n.ratings.push({userEmail:a,rating:i,timestamp:new Date().toISOString()}),this.checkAndUpdateStatus(s),this.saveGuias(),this.guias[s]}calculateAverageRating(t){return t&&t._ratingAggregate&&typeof t._ratingAggregate.average=="number"?t._ratingAggregate.average:!t.ratings||t.ratings.length===0?0:t.ratings.reduce((i,e)=>i+e.rating,0)/t.ratings.length}isWithinEvaluationPeriod(t){const a=new Date(t.criadoEm);return(new Date-a)/(1e3*60*60*24)<=7}checkAndUpdateStatus(t){const a=this.guias[t];if(this.isWithinEvaluationPeriod(a)){const i=this.calculateAverageRating(a);i!==null&&i<3&&(this.guias[t].status="oculto")}}async getVisibleGuias(t=null){return await this.loadGuias(),this.guias.filter(a=>t&&a.autorEmail===t?!0:a.status==="ativo")}async getGuiaById(t){return await this.loadGuias(),this.guias.find(a=>a.id===t)}getGuiasByAutor(t){return this.guias.filter(a=>a.autorEmail===t)}incrementViews(t){const a=this.guias.findIndex(i=>i.id===t);a!==-1&&(this.guias[a].views=(this.guias[a].views||0)+1,this.saveGuias())}getGuiaStats(t){const a=this.calculateAverageRating(t),i=this.isWithinEvaluationPeriod(t),e=i?Math.ceil(7-(new Date-new Date(t.criadoEm))/(1e3*60*60*24)):0,s=t&&t._ratingAggregate&&typeof t._ratingAggregate.total=="number"?t._ratingAggregate.total:t.ratings?t.ratings.length:0;return{averageRating:a,totalRatings:s,views:t.views||0,isInEvaluationPeriod:i,evaluationDaysRemaining:e,status:t.status}}}const w=new g;export{w as g};
