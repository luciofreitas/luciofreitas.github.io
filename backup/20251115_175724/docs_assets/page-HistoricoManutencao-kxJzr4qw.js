import{r as c,A as $,a as H,u as q,j as e,M as O}from"./index-DybRcGxg.js";import{M as R}from"./index.esm-CWpXVLZg.js";import{g as f,u as B,a as z,d as P}from"./maintenanceService-DOGDJ6m6.js";import{g as Q}from"./carService-B4lSvgg8.js";function U(){const{usuarioLogado:l}=c.useContext($)||{},[n,j]=c.useState([]),[p,I]=c.useState([]),[M,C]=c.useState(!0),[E,u]=c.useState(!1),[v,y]=c.useState(null),[N,F]=c.useState("todos"),[k,b]=c.useState(""),[o,t]=c.useState({veiculoId:"",data:"",tipo:"preventiva",descricao:"",kmAtual:"",oficina:"",valor:"",observacoes:""}),h=H(),S=q();c.useEffect(()=>{(async()=>{if(l){C(!0);try{const i=l.id||l.email,s=await Q(i);I(s);const r=await f(i);j(r)}catch(i){console.error("Erro ao carregar dados:",i)}finally{C(!1)}}})()},[l]),c.useEffect(()=>{try{const a=h&&h.state&&h.state.openMaintenanceId,i=h&&h.state&&h.state.prefillDescricao||(()=>{try{return sessionStorage.getItem("pf_prefill_descricao")}catch{return null}})();if(a&&n&&n.length>0){const s=n.find(r=>String(r.id)===String(a));if(s){const r=i&&(!s.descricao||String(s.descricao).trim()==="")?{...s,descricao:i}:s;w(r);try{S(h.pathname+(window.location.hash||""),{replace:!0})}catch{}}}else if(i){x(),t(s=>({...s,descricao:i})),u(!0);try{S(h.pathname+(window.location.hash||""),{replace:!0})}catch{}try{sessionStorage.removeItem("pf_prefill_descricao")}catch{}}}catch{}},[h,n]),c.useEffect(()=>{const a=i=>{try{const s=i&&i.detail?i.detail:null,r=s&&s.openMaintenanceId,m=s&&s.prefillDescricao;if(r&&n&&n.length>0){const d=n.find(g=>String(g.id)===String(r));if(d){const g=m&&(!d.descricao||String(d.descricao).trim()==="")?{...d,descricao:m}:d;w(g);try{sessionStorage.removeItem("pf_prefill_descricao")}catch{}return}}if(m){x(),t(d=>({...d,descricao:m})),u(!0);try{sessionStorage.removeItem("pf_prefill_descricao")}catch{}}}catch{}};return window.addEventListener("pf_open_maintenance",a),()=>window.removeEventListener("pf_open_maintenance",a)},[n]);const A=async a=>{if(a.preventDefault(),!l)return;const i=l.id||l.email;try{if(v){await B(i,v,o);const s=await f(i);j(s)}else{await z(i,o);const s=await f(i);j(s)}x(),u(!1)}catch(s){console.error("Erro ao salvar manuten√ß√£o:",s),alert("Erro ao salvar manuten√ß√£o. Tente novamente.")}},w=a=>{const i=a&&(a.data||a.createdAt||new Date().toISOString());let s="";if(i){const r=new Date(i);if(!isNaN(r.getTime())){const m=r.getFullYear(),d=String(r.getMonth()+1).padStart(2,"0"),g=String(r.getDate()).padStart(2,"0");s=`${m}-${d}-${g}`}}t({...a,data:s}),y(a.id),b(a.veiculoId),u(!0)},L=async a=>{if(!window.confirm("Tem certeza que deseja excluir este registro?")||!l)return;const i=l.id||l.email;try{await P(i,a);const s=await f(i);j(s)}catch(s){console.error("Erro ao deletar manuten√ß√£o:",s),alert("Erro ao deletar manuten√ß√£o. Tente novamente.")}},x=()=>{t({veiculoId:"",data:"",tipo:"preventiva",descricao:"",kmAtual:"",oficina:"",valor:"",observacoes:""}),y(null),b("")},_=a=>{b(a),a&&t({...o,veiculoId:a})},T=a=>{const i=p.find(s=>String(s.id)===String(a));return i?`${i.marca} ${i.modelo} (${i.ano})`:"Ve√≠culo n√£o encontrado"},V=a=>{const i=a&&(a.data||a.createdAt||a.createdAt)||"",s=i?new Date(i):new Date;return isNaN(s.getTime())?new Date().toLocaleDateString("pt-BR"):s.toLocaleDateString("pt-BR")},D=[...N==="todos"?n:n.filter(a=>a.veiculoId===N)].sort((a,i)=>new Date(i.data)-new Date(a.data));return l?e.jsxs(e.Fragment,{children:[e.jsx(R,{}),e.jsx("div",{className:"site-header-spacer"}),e.jsx("div",{className:"page-wrapper menu-page historico-page",children:e.jsxs("div",{className:"page-content historico-section",children:[e.jsx("h2",{className:"page-title",children:"Hist√≥rico de Manuten√ß√£o"}),e.jsx("div",{className:"historico-intro",children:e.jsx("p",{children:"Mantenha um registro completo de todas as manuten√ß√µes, trocas de pe√ßas e servi√ßos realizados nos seus ve√≠culos. Esse hist√≥rico digital facilita o acompanhamento de revis√µes peri√≥dicas e aumenta o valor de revenda."})}),M?e.jsx("div",{className:"historico-loading",children:e.jsx("p",{children:"Carregando dados..."})}):p.length===0?e.jsxs("div",{className:"historico-no-cars",children:[e.jsx("p",{children:"Voc√™ ainda n√£o possui ve√≠culos cadastrados."}),e.jsx("p",{children:"Cadastre seu primeiro ve√≠culo para come√ßar a registrar manuten√ß√µes."}),e.jsx("button",{onClick:()=>S("/meus-carros"),className:"historico-add-car-btn",children:"üìù Ir para Meus Carros"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"historico-actions",children:[e.jsxs("div",{className:"historico-filters",children:[e.jsx("label",{htmlFor:"filtro-veiculo",children:"Filtrar por ve√≠culo:"}),e.jsxs("select",{id:"filtro-veiculo",value:N,onChange:a=>F(a.target.value),className:"historico-select",children:[e.jsx("option",{value:"todos",children:"Todos os ve√≠culos"}),p.map(a=>e.jsxs("option",{value:a.id,children:[a.marca," ",a.modelo," (",a.ano,")"]},a.id))]})]}),e.jsx("button",{className:"historico-add-btn",onClick:()=>{x(),u(!0)},children:"+ Nova Manuten√ß√£o"})]}),D.length===0?e.jsxs("div",{className:"historico-empty",children:[e.jsx("p",{children:"Nenhuma manuten√ß√£o registrada ainda."}),e.jsx("p",{children:'Clique em "Nova Manuten√ß√£o" para come√ßar.'})]}):e.jsx("div",{className:"historico-list",children:D.map(a=>e.jsxs("div",{className:"historico-card",children:[e.jsxs("div",{className:"historico-card-header",children:[e.jsx("div",{className:"historico-card-veiculo",children:T(a.veiculoId)}),e.jsx("div",{className:"historico-card-data",children:V(a)})]}),e.jsxs("div",{className:"historico-card-body",children:[e.jsx("div",{className:"historico-card-tipo",children:e.jsx("span",{className:`historico-tipo-badge ${a.tipo}`,children:a.tipo==="preventiva"?"Preventiva":a.tipo==="corretiva"?"Corretiva":"Outro"})}),e.jsxs("div",{className:"historico-card-descricao",children:[e.jsx("strong",{children:"Descri√ß√£o:"})," ",a.descricao]}),a.kmAtual&&e.jsxs("div",{className:"historico-card-km",children:[e.jsx("strong",{children:"Quilometragem:"})," ",parseInt(a.kmAtual).toLocaleString("pt-BR")," km"]}),a.oficina&&e.jsxs("div",{className:"historico-card-oficina",children:[e.jsx("strong",{children:"Oficina:"})," ",a.oficina]}),a.valor&&e.jsxs("div",{className:"historico-card-valor",children:[e.jsx("strong",{children:"Valor:"})," R$ ",parseFloat(a.valor).toLocaleString("pt-BR",{minimumFractionDigits:2})]}),a.observacoes&&e.jsxs("div",{className:"historico-card-obs",children:[e.jsx("strong",{children:"Observa√ß√µes:"})," ",a.observacoes]})]}),e.jsxs("div",{className:"historico-card-actions",children:[e.jsx("button",{className:"historico-edit-btn",onClick:()=>w(a),children:"Editar"}),e.jsx("button",{className:"historico-delete-btn",onClick:()=>L(a.id),children:"Excluir"})]})]},a.id))})]}),E&&e.jsx("div",{className:"historico-modal-overlay",onClick:()=>u(!1),children:e.jsxs("div",{className:"historico-modal",onClick:a=>a.stopPropagation(),children:[e.jsxs("div",{className:"historico-modal-header",children:[e.jsx("h3",{children:v?"Editar Manuten√ß√£o":"Nova Manuten√ß√£o"}),e.jsx("button",{className:"historico-modal-close",onClick:()=>u(!1),children:"√ó"})]}),e.jsxs("form",{onSubmit:A,className:"historico-form",children:[!v&&p.length>0&&e.jsxs("div",{className:"historico-form-group historico-car-helper",children:[e.jsx("label",{htmlFor:"carroHelper",children:"üöó Selecione um ve√≠culo cadastrado (facilita o preenchimento)"}),e.jsxs("select",{id:"carroHelper",value:k,onChange:a=>_(a.target.value),className:"historico-input historico-car-selector",children:[e.jsx("option",{value:"",children:"-- Selecione um carro cadastrado --"}),p.map(a=>e.jsxs("option",{value:a.id,children:[a.marca," ",a.modelo," (",a.ano,")",a.isDefault?" ‚≠ê":""]},a.id))]}),e.jsx("small",{className:"historico-helper-text",children:'Ao selecionar um ve√≠culo, o campo "Ve√≠culo" ser√° preenchido automaticamente'})]}),e.jsxs("div",{className:"historico-form-group",children:[e.jsx("label",{htmlFor:"veiculoId",children:"Ve√≠culo *"}),e.jsxs("select",{id:"veiculoId",value:o.veiculoId,onChange:a=>t({...o,veiculoId:a.target.value}),required:!0,className:"historico-input",children:[e.jsx("option",{value:"",children:"Selecione um ve√≠culo"}),p.map(a=>e.jsxs("option",{value:a.id,children:[a.marca," ",a.modelo," (",a.ano,")"]},a.id))]})]}),e.jsxs("div",{className:"historico-form-row",children:[e.jsxs("div",{className:"historico-form-group",children:[e.jsx("label",{htmlFor:"data",children:"Data *"}),e.jsx("input",{type:"date",id:"data",value:o.data,onChange:a=>t({...o,data:a.target.value}),required:!0,className:"historico-input"})]}),e.jsxs("div",{className:"historico-form-group",children:[e.jsx("label",{htmlFor:"tipo",children:"Tipo *"}),e.jsxs("select",{id:"tipo",value:o.tipo,onChange:a=>t({...o,tipo:a.target.value}),required:!0,className:"historico-input",children:[e.jsx("option",{value:"preventiva",children:"Preventiva"}),e.jsx("option",{value:"corretiva",children:"Corretiva"}),e.jsx("option",{value:"outro",children:"Outro"})]})]})]}),e.jsxs("div",{className:"historico-form-group",children:[e.jsx("label",{htmlFor:"descricao",children:"Descri√ß√£o *"}),e.jsx("input",{type:"text",id:"descricao",value:o.descricao,onChange:a=>t({...o,descricao:a.target.value}),placeholder:"Ex: Troca de √≥leo e filtro",required:!0,className:"historico-input"})]}),e.jsxs("div",{className:"historico-form-row",children:[e.jsxs("div",{className:"historico-form-group",children:[e.jsx("label",{htmlFor:"kmAtual",children:"Quilometragem"}),e.jsx("input",{type:"number",id:"kmAtual",value:o.kmAtual,onChange:a=>t({...o,kmAtual:a.target.value}),placeholder:"Ex: 50000",className:"historico-input"})]}),e.jsxs("div",{className:"historico-form-group",children:[e.jsx("label",{htmlFor:"valor",children:"Valor (R$)"}),e.jsx("input",{type:"number",step:"0.01",id:"valor",value:o.valor,onChange:a=>t({...o,valor:a.target.value}),placeholder:"Ex: 150.00",className:"historico-input"})]})]}),e.jsxs("div",{className:"historico-form-group",children:[e.jsx("label",{htmlFor:"oficina",children:"Oficina/Local"}),e.jsx("input",{type:"text",id:"oficina",value:o.oficina,onChange:a=>t({...o,oficina:a.target.value}),placeholder:"Ex: Auto Center XYZ",className:"historico-input"})]}),e.jsxs("div",{className:"historico-form-group",children:[e.jsx("label",{htmlFor:"observacoes",children:"Observa√ß√µes"}),e.jsx("textarea",{id:"observacoes",value:o.observacoes,onChange:a=>t({...o,observacoes:a.target.value}),placeholder:"Informa√ß√µes adicionais sobre a manuten√ß√£o",rows:"3",className:"historico-textarea"})]}),e.jsxs("div",{className:"historico-form-actions",children:[e.jsx("button",{type:"button",className:"historico-cancel-btn",onClick:()=>{x(),u(!1)},children:"Cancelar"}),e.jsx("button",{type:"submit",className:"historico-save-btn",children:v?"Salvar Altera√ß√µes":"Adicionar Manuten√ß√£o"})]})]})]})})]})})]}):e.jsxs(e.Fragment,{children:[e.jsx(O,{}),e.jsx("div",{className:"page-wrapper",children:e.jsxs("div",{className:"page-content historico-section",children:[e.jsx("h2",{className:"page-title",children:"Hist√≥rico de Manuten√ß√£o"}),e.jsxs("div",{className:"historico-login-required",children:[e.jsx("p",{children:"Voc√™ precisa estar logado para acessar o hist√≥rico de manuten√ß√£o."}),e.jsx("a",{href:"/#/login",className:"historico-login-btn",children:"Fazer Login"})]})]})})]})}export{U as default};
